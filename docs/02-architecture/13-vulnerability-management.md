# 🛡️ GESTIÓN DE VULNERABILIDADES - Sistema IRCCA

**Versión:** 1.0  
**Fecha:** 08-Oct-2025  
**Propósito:** Documentar el proceso de gestión de vulnerabilidades en dependencias y código fuente para mantener el sistema seguro en producción.

**Cumplimiento:** Requisito SO.1 - Marco de Ciberseguridad AGESIC

---

## 📋 Resumen Ejecutivo

### 🎯 Objetivo

Establecer un proceso sistemático para:
- ✅ Detectar vulnerabilidades en dependencias npm
- ✅ Priorizar y remediar según severidad
- ✅ Mantener registro de auditorías
- ✅ Prevenir introducción de código vulnerable

---

## 🔍 Herramientas de Detección

### **1. npm audit**

Herramienta oficial de npm que analiza el árbol de dependencias contra la base de datos de vulnerabilidades conocidas.

**Comandos disponibles:**

```bash
# Auditoría básica (solo dependencias de producción)
pnpm run audit

# Auditoría con corrección automática
pnpm run audit:fix

# Generar reporte JSON
pnpm run audit:report

# Verificación completa (lint + audit)
pnpm run security:check
```

**Configuración:**

```json
{
  "scripts": {
    "audit": "npm audit --production",
    "audit:fix": "npm audit fix",
    "audit:report": "npm audit --json > audit-report.json",
    "security:check": "run-s lint:check audit"
  }
}
```

---

### **2. ESLint Security Plugin**

Plugin de seguridad estática que detecta patrones inseguros en el código.

**Reglas activas:**

```typescript
// eslint.config.ts
{
  'security/detect-unsafe-regex': 'error',          // CRÍTICO
  'security/detect-buffer-noassert': 'error',       // CRÍTICO
  'security/detect-eval-with-expression': 'error',  // CRÍTICO
  'security/detect-object-injection': 'warn',
  'security/detect-non-literal-regexp': 'warn',
  'security/detect-possible-timing-attacks': 'warn'
}
```

**Ejecución:**

```bash
pnpm run lint       # Ejecutar y auto-corregir
pnpm run lint:check # Solo verificar sin modificar
```

---

### **3. TypeScript Strict Mode**

TypeScript en modo estricto previene vulnerabilidades por tipos incorrectos.

**Configuración:** `tsconfig.json`

```json
{
  "compilerOptions": {
    "strict": true,
    "noImplicitAny": true,
    "strictNullChecks": true,
    "strictFunctionTypes": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true
  }
}
```

**Ejecución:**

```bash
pnpm run type-check
```

---

## 📊 Niveles de Severidad

### **Clasificación npm audit:**

| Severidad | Descripción | Acción Requerida | Tiempo |
|-----------|-------------|------------------|--------|
| **CRITICAL** | Explotación remota, pérdida de datos | ⚠️ INMEDIATA | < 24h |
| **HIGH** | Impacto significativo en seguridad | 🔴 URGENTE | < 1 semana |
| **MODERATE** | Impacto limitado | 🟡 PRIORITARIO | < 1 mes |
| **LOW** | Impacto mínimo | 🟢 PLANIFICADO | Próximo release |
| **INFO** | Sin impacto en seguridad | ℹ️ OPCIONAL | A consideración |

---

## 🔄 Proceso de Gestión

### **Fase 1: Detección (Semanal)**

**Cada lunes:**

```bash
# 1. Actualizar información de vulnerabilidades
pnpm outdated

# 2. Ejecutar auditoría
pnpm run audit

# 3. Generar reporte si hay hallazgos
pnpm run audit:report
```

**Automatización (opcional):**

```bash
# Agregar a GitHub Actions o cron
0 9 * * 1  cd /path/to/project && pnpm run audit
```

---

### **Fase 2: Análisis y Priorización**

**Cuando se detecta vulnerabilidad:**

1. **Verificar severidad**
   ```bash
   pnpm audit
   ```

2. **Revisar detalles**
   - Descripción de la vulnerabilidad
   - Versiones afectadas
   - Solución disponible
   - Path de dependencia

3. **Evaluar impacto en el proyecto**
   - ¿La funcionalidad vulnerable se usa?
   - ¿Hay datos sensibles expuestos?
   - ¿Es dependencia de producción o desarrollo?

4. **Priorizar según matriz:**

```
┌─────────────────────────────────────────────────┐
│  SEVERIDAD  │  USO ACTIVO  │  PRIORIDAD FINAL  │
│─────────────┼──────────────┼───────────────────│
│  CRITICAL   │     SÍ       │  ⚠️ INMEDIATA     │
│  CRITICAL   │     NO       │  🔴 URGENTE       │
│  HIGH       │     SÍ       │  🔴 URGENTE       │
│  HIGH       │     NO       │  🟡 PRIORITARIO   │
│  MODERATE   │     SÍ       │  🟡 PRIORITARIO   │
│  MODERATE   │     NO       │  🟢 PLANIFICADO   │
│  LOW/INFO   │     -        │  🟢 PLANIFICADO   │
└─────────────────────────────────────────────────┘
```

---

### **Fase 3: Remediación**

**Opción A: Actualización automática**

```bash
# Intenta corregir automáticamente
pnpm run audit:fix

# Verifica que no se rompió nada
pnpm run test:all
pnpm run build
```

**Opción B: Actualización manual**

```bash
# Actualizar paquete específico
pnpm update <paquete>@latest

# O editar package.json y reinstalar
pnpm install
```

**Opción C: Alternativa**

Si no hay actualización disponible:

```bash
# Buscar paquete alternativo
pnpm search <alternativa>

# Instalar reemplazo
pnpm remove <paquete-vulnerable>
pnpm add <paquete-alternativo>
```

**Opción D: Mitigación temporal**

Si no es posible actualizar inmediatamente:

1. Documentar el riesgo
2. Implementar controles compensatorios
3. Planificar actualización en siguiente sprint

---

### **Fase 4: Verificación**

**Después de remediar:**

```bash
# 1. Verificar que se solucionó
pnpm run audit

# 2. Ejecutar suite de tests
pnpm run test:all

# 3. Verificar type-checking
pnpm run type-check

# 4. Ejecutar lint
pnpm run lint:check

# 5. Build de producción
pnpm run build
```

**Si todo pasa:**
✅ Commit y push
```bash
git add package.json pnpm-lock.yaml
git commit -m "security: fix vulnerability in <paquete>"
git push
```

---

### **Fase 5: Documentación**

**Registrar en:** `docs/03-security/vulnerability-log.md`

```markdown
## [2025-10-08] Vulnerabilidad en <paquete>

**Severidad:** HIGH  
**CVE:** CVE-2024-XXXXX  
**Descripción:** <descripción breve>

**Acción tomada:**
- Actualizado <paquete> de v1.0.0 a v1.2.0
- Tests ejecutados: ✅ PASS
- Build verificado: ✅ OK

**Verificado por:** Mario BERNI  
**Fecha de resolución:** 2025-10-08
```

---

## 🚫 Dependencias Prohibidas

### **Lista de paquetes NO permitidos:**

```javascript
// ❌ PROHIBIDO - Usar en su lugar:
'eval'              // ❌ NO usar nunca
'Function()'        // ❌ NO usar nunca
'vm'                // ❌ Módulo peligroso (Node.js)
'child_process'     // ❌ Ejecución de comandos (Node.js)

// ⚠️ EVITAR - Buscar alternativas:
'lodash'            // ⚠️ Usar @vueuse/core o nativo ES6
'moment'            // ⚠️ Usar date-fns o nativo Date
'request'           // ⚠️ Deprecated, usar fetch o axios
```

### **Criterios para agregar nueva dependencia:**

```
✅ Checklist antes de `pnpm add <paquete>`:

[ ] ¿Es realmente necesario?
[ ] ¿Puedo lograrlo con código nativo?
[ ] ¿Está activamente mantenido? (commit en últimos 6 meses)
[ ] ¿Tiene buena reputación? (>1000 descargas semanales)
[ ] ¿No tiene vulnerabilidades conocidas?
[ ] ¿Licencia compatible? (MIT, Apache, BSD)
[ ] ¿TypeScript support?
[ ] ¿Tests incluidos?
```

---

## 📅 Calendario de Auditorías

### **Frecuencia:**

| Actividad | Frecuencia | Responsable | Herramienta |
|-----------|------------|-------------|-------------|
| **Auditoría de dependencias** | Semanal (lunes) | Custodio Técnico | `pnpm audit` |
| **Revisión de outdated** | Mensual | Custodio Técnico | `pnpm outdated` |
| **Actualización preventiva** | Trimestral | Custodio Técnico | `pnpm update` |
| **Auditoría de código** | Cada commit | Automático | ESLint Security |
| **Revisión manual** | Cada PR/merge | Custodio Técnico | Code Review |

### **Eventos especiales:**

- **Nueva CVE crítica publicada:** Auditoría inmediata
- **Antes de cada release:** Auditoría completa + reporte
- **Después de agregar dependencia:** Auditoría + tests

---

## 📈 Métricas de Seguridad

### **KPIs a monitorear:**

```
┌──────────────────────────────────────────────────────┐
│  MÉTRICA                    │  OBJETIVO  │  ACTUAL   │
│─────────────────────────────┼────────────┼───────────│
│  Vulnerabilidades CRITICAL  │     0      │    ✅ 0   │
│  Vulnerabilidades HIGH      │     0      │    ✅ 0   │
│  Vulnerabilidades MODERATE  │    < 3     │    ✅ 0   │
│  Tiempo respuesta CRITICAL  │   < 24h    │    ✅     │
│  Tiempo respuesta HIGH      │  < 1 sem   │    ✅     │
│  Dependencias outdated      │    < 5     │    📊     │
│  Última auditoría           │  < 7 días  │    ✅     │
└──────────────────────────────────────────────────────┘
```

**Comando para verificar:**

```bash
# Estado actual
pnpm audit

# Dependencias desactualizadas
pnpm outdated

# Último commit de seguridad
git log --grep="security" -n 1
```

---

## 🔐 Integración Continua

### **Pre-commit Hook (Opcional)**

```bash
# .husky/pre-commit
#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

# Ejecutar lint y audit antes de commit
pnpm run lint:check
pnpm run audit
```

### **GitHub Actions (Recomendado)**

```yaml
# .github/workflows/security.yml
name: Security Audit

on:
  push:
    branches: [main]
  pull_request:
  schedule:
    - cron: '0 9 * * 1'  # Cada lunes 9am

jobs:
  audit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: pnpm/action-setup@v2
      - run: pnpm install --frozen-lockfile
      - run: pnpm audit --production
      - run: pnpm run lint:check
```

---

## 📝 Procedimiento de Emergencia

### **Si se descubre vulnerabilidad CRITICAL en producción:**

**Paso 1: Evaluación inmediata (< 1 hora)**

```bash
# 1. Reproducir vulnerabilidad
pnpm audit

# 2. Verificar si afecta al sistema
# - ¿Funcionalidad vulnerable en uso?
# - ¿Datos sensibles expuestos?
# - ¿Vector de ataque disponible?
```

**Paso 2: Contención (< 2 horas)**

```bash
# Opción A: Desplegar hotfix
pnpm run audit:fix
pnpm run test:all
pnpm run build
# Desplegar inmediatamente

# Opción B: Deshabilitar funcionalidad
# Si no hay fix disponible, deshabilitar feature afectada
```

**Paso 3: Comunicación (< 3 horas)**

```markdown
# Notificar a:
- ✅ Dirección del IRCCA
- ✅ Usuario administrador del sistema
- ✅ AGESIC (si aplica por normativa)

# Template de comunicación:
Asunto: [URGENTE] Vulnerabilidad de seguridad detectada

Se detectó una vulnerabilidad CRITICAL en dependencia <paquete>.
- Impacto: <descripción>
- Acción tomada: <corrección aplicada>
- Estado actual: <resuelto/en proceso>
```

**Paso 4: Remediación definitiva (< 24 horas)**

```bash
# Actualizar dependencia
pnpm update <paquete>@latest

# Suite completa de verificación
pnpm run security:check
pnpm run test:all
pnpm run build

# Desplegar a producción
git commit -m "security(critical): fix CVE-XXXX in <paquete>"
git push
```

**Paso 5: Post-mortem (< 48 horas)**

Documentar en `docs/03-security/incident-YYYY-MM-DD.md`:
- Qué pasó
- Cómo se detectó
- Impacto real
- Cómo se solucionó
- Lecciones aprendidas
- Mejoras a implementar

---

## 📚 Referencias y Recursos

### **Bases de datos de vulnerabilidades:**

- **npm Advisory:** https://www.npmjs.com/advisories
- **Snyk Vulnerability DB:** https://security.snyk.io/
- **GitHub Advisory:** https://github.com/advisories
- **CVE:** https://cve.mitre.org/
- **NVD (NIST):** https://nvd.nist.gov/

### **Herramientas adicionales (opcional):**

```bash
# Snyk (más completo que npm audit)
npx snyk test

# Retire.js (vulnerabilidades en JavaScript)
npx retire

# OWASP Dependency Check
# (para proyectos más grandes)
```

---

## ✅ Checklist de Cumplimiento

**Para auditoría AGESIC:**

```markdown
[ ] ✅ Proceso documentado formalmente
[ ] ✅ Herramientas de detección configuradas
[ ] ✅ Calendario de auditorías establecido
[ ] ✅ Scripts automatizados creados
[ ] ✅ Procedimiento de emergencia definido
[ ] ✅ Registro de vulnerabilidades mantenido
[ ] ✅ Responsable designado (Custodio Técnico)
[ ] ✅ Verificación en cada commit (ESLint Security)
[ ] ✅ Estado actual: 0 vulnerabilidades críticas/altas
```

---

## 📝 Control de Versiones

| Versión | Fecha | Autor | Cambios |
|---------|-------|-------|---------|
| 1.0 | 08-Oct-2025 | Mario BERNI | Versión inicial - Cumplimiento SO.1 |

---

**Custodio Técnico:** Mario BERNI  
**Próxima revisión:** 08-Ene-2026
